# 要件ドキュメント

## はじめに

このドキュメントでは、Google Search Console MCPサーバーの認証方法をサービスアカウントからOAuth2認証に移行するための要件を定義します。セキュリティの観点からサービスアカウントによる認証方法は推奨されておらず、システムに組み込む場合に脆弱性を生む可能性があるため、OAuth2認証に完全に移行します。これにより、個人のGoogle Search Consoleアカウントを使用してAPIにアクセスできるようになります。

## 要件

### 要件1：OAuth2認証フローのサポート

**ユーザーストーリー:** 開発者として、OAuth2認証フローを使用してGoogle Search Consoleにアクセスできるようにしたいので、個人のGoogle Search Consoleアカウントの権限でAPIを利用できるようになります。

#### 受け入れ基準

1. WHEN サーバーが起動される THEN システムはクライアントIDとクライアントシークレットを環境変数またはコマンドラインパラメーターから読み込むこと
2. WHEN `setup`サブコマンドが指定される THEN システムはOAuth2認証フローを開始すること
3. WHEN OAuth2認証フローが完了する THEN システムはリフレッシュトークンをローカルに保存すること
4. WHEN リフレッシュトークンの保存パスが指定される THEN システムはMCPサーバーとして起動し、保存されたトークンを使用して認証すること
5. IF リフレッシュトークンが期限切れまたは無効である THEN システムは適切なエラーメッセージを表示し、再認証を促すこと

### 要件2：サービスアカウント認証の廃止とOAuth2への移行

**ユーザーストーリー:** 開発者として、セキュアなOAuth2認証のみを使用してGoogle Search Consoleにアクセスしたいので、サービスアカウント認証に関連するセキュリティリスクを排除できるようになります。

#### 受け入れ基準

1. WHEN サーバーが起動される THEN システムはサービスアカウント認証をサポートしないこと
2. WHEN サービスアカウント認証情報が提供される THEN システムは非推奨の警告を表示し、OAuth2認証の使用を促すこと
3. WHEN OAuth2のリフレッシュトークンが提供される THEN システムはOAuth2認証を使用すること
4. IF 認証情報が提供されない THEN システムは適切なエラーメッセージを表示し、OAuth2認証情報の提供方法を説明すること

### 要件3：設定の保存と管理

**ユーザーストーリー:** 開発者として、OAuth2認証の設定を簡単に管理したいので、認証情報を安全に保存し、必要に応じて更新できるようになります。

#### 受け入れ基準

1. WHEN OAuth2認証が完了する THEN システムはリフレッシュトークンを指定されたパスに保存すること
2. WHEN リフレッシュトークンファイルが存在する THEN システムはそのトークンを読み込んで認証に使用すること
3. WHEN `--token-path`パラメーターが指定される THEN システムはそのパスからトークンを読み込むこと
4. IF トークンファイルが存在しない THEN システムは適切なエラーメッセージを表示し、セットアップ手順を説明すること
5. WHEN トークンが保存される THEN システムはファイルに適切なアクセス権限を設定し、セキュリティを確保すること

### 要件4：ドキュメントとヘルプ

**ユーザーストーリー:** 開発者として、OAuth2認証の設定方法と使用方法を理解したいので、明確なドキュメントとヘルプ情報が提供されるようになります。

#### 受け入れ基準

1. WHEN `--help`フラグが指定される THEN システムは利用可能なすべてのコマンドとオプションを表示すること
2. WHEN サーバーが起動する THEN システムは現在使用している認証方法を表示すること
3. WHEN エラーが発生する THEN システムは問題を解決するための具体的な手順を含むエラーメッセージを表示すること
4. WHEN READMEが更新される THEN OAuth2認証の設定と使用方法に関する詳細な説明が含まれること